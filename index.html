<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ø§Ø®ØªØ¨Ø§Ø± ØªØªØ¨Ù‘Ø¹ Ø§Ù„Ù…Ø³Ø§Ø± - MoCA</title>
  <style>
    body { text-align: center; font-family: Arial; background: #f5f5f5; }
    canvas { border: 1px solid #000; touch-action: none; background-color: white; }
    button { margin: 5px; padding: 8px 15px; font-size: 16px; cursor: pointer; }
  </style>
</head>
<body>

<h2>Ø§Ø®ØªØ¨Ø§Ø± ØªØªØ¨Ù‘Ø¹ Ø§Ù„Ù…Ø³Ø§Ø± - MoCA</h2>
<canvas id="drawCanvas"></canvas><br>
<button onclick="resetCanvas()">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø©</button>
<button onclick="downloadAll()">â¬‡ï¸ ØªÙ†Ø²ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© + Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>

<script>
let canvas = document.getElementById('drawCanvas');
let ctx = canvas.getContext('2d');

let bgImage = new Image();
bgImage.src = "moca.png"; // ØµÙˆØ±Ø© Ø§Ù„Ø®Ù„ÙÙŠØ©

let screenWidth = window.innerWidth;
let screenHeight = window.innerHeight;
let canvasWidth, canvasHeight;

function resizeCanvas() {
    let ratio = bgImage.width / bgImage.height || (4/3);
    let maxWidth = screenWidth * 0.95;
    let width = maxWidth;
    let height = width / ratio;

    if (height > screenHeight * 0.7) {
        height = screenHeight * 0.7;
        width = height * ratio;
    }

    canvas.width = width;
    canvas.height = height;
    canvasWidth = width;
    canvasHeight = height;

    drawBackground();
}

function drawBackground() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(bgImage, 0, 0, canvas.width, canvas.height);
}

bgImage.onload = resizeCanvas;
window.addEventListener('resize', resizeCanvas);

let drawing = false;
let startTime = null;
let points = [];
let lastPoint = null;

function getRelativeCoords(evt) {
    let rect = canvas.getBoundingClientRect();
    let x = evt.clientX - rect.left;
    let y = evt.clientY - rect.top;
    let nx = x / canvas.width;
    let ny = y / canvas.height;
    return { x, y, nx, ny };
}

function startDraw(evt) {
    drawing = true;
    ctx.beginPath();
    let coords = getRelativeCoords(evt);
    ctx.moveTo(coords.x, coords.y);
    if (!startTime) startTime = Date.now();
    savePoint(coords);
}

function draw(evt) {
    if (!drawing) return;
    let coords = getRelativeCoords(evt);
    ctx.lineTo(coords.x, coords.y);
    ctx.strokeStyle = 'black';
    ctx.lineWidth = 2;
    ctx.stroke();
    savePoint(coords);
}

function endDraw() {
    drawing = false;
    ctx.closePath();
}

function savePoint(coords) {
    let t = (Date.now() - startTime) / 1000.0; // Ø«ÙˆØ§Ù†ÙŠ
    let p = {
        x: coords.x,
        y: coords.y,
        nx: coords.nx,
        ny: coords.ny,
        t: t
    };
    points.push(p);
    lastPoint = p;
}

function resetCanvas() {
    drawBackground();
    points = [];
    startTime = null;
    lastPoint = null;
}

// Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù…Ø§ÙˆØ³
canvas.addEventListener('mousedown', startDraw);
canvas.addEventListener('mousemove', draw);
canvas.addEventListener('mouseup', endDraw);

// Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù„Ù…Ø³
canvas.addEventListener('touchstart', e => startDraw(e.touches[0]));
canvas.addEventListener('touchmove', e => {
    draw(e.touches[0]);
    e.preventDefault();
});
canvas.addEventListener('touchend', endDraw);

// ğŸ§© Ø¯Ø§Ù„Ø© Resampling ÙƒÙ„ 0.05 Ø«Ø§Ù†ÙŠØ© (Ù…Ø¹ ØªØ«Ø¨ÙŠØª Ø¢Ø®Ø± Ù†Ù‚Ø·Ø©)
function resample(points, step = 0.05) {
    if (points.length < 2) return points;

    let resampled = [];
    let startT = points[0].t;
    let endT = points[points.length - 1].t;
    let targetT = startT;

    let i = 0;
    while (targetT <= endT) {
        while (i < points.length - 1 && points[i+1].t < targetT) {
            i++;
        }

        let p1 = points[i];
        let p2 = points[Math.min(i+1, points.length-1)];

        let ratio = (targetT - p1.t) / (p2.t - p1.t || 1);
        let x = p1.x + ratio * (p2.x - p1.x);
        let y = p1.y + ratio * (p2.y - p1.y);
        let nx = x / canvas.width;
        let ny = y / canvas.height;

        resampled.push({x, y, nx, ny, t: targetT});
        targetT += step;
    }

    // Ø¥Ø¶Ø§ÙØ© Ø¢Ø®Ø± Ù†Ù‚Ø·Ø© Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø· Ù„ØªØ«Ø¨ÙŠØª Ø§Ù„Ù‚ÙŠÙ…
    let last = points[points.length - 1];
    resampled.push({
        x: last.x,
        y: last.y,
        nx: last.nx,
        ny: last.ny,
        t: endT
    });

    return resampled;
}

// â¬‡ï¸ ØªÙ†Ø²ÙŠÙ„ ØµÙˆØ±Ø© + JSON
function downloadAll() {
    // ØµÙˆØ±Ø© Ø§Ù„Ø®Ø· ÙÙ‚Ø·
    let tempCanvas = document.createElement('canvas');
    tempCanvas.width = canvas.width;
    tempCanvas.height = canvas.height;
    let tempCtx = tempCanvas.getContext('2d');

    tempCtx.lineWidth = 2;
    tempCtx.strokeStyle = 'black';
    tempCtx.beginPath();

    for (let i = 0; i < points.length; i++) {
        let p = points[i];
        if (i === 0) {
            tempCtx.moveTo(p.x, p.y);
        } else {
            tempCtx.lineTo(p.x, p.y);
        }
    }

    tempCtx.stroke();

    let linkImg = document.createElement('a');
    linkImg.download = `drawing_${Date.now()}.png`;
    linkImg.href = tempCanvas.toDataURL("image/png");
    linkImg.click();

    // JSON
    let resampledPoints = resample(points, 0.05);
    let data = {
        screenWidth: screenWidth,
        screenHeight: screenHeight,
        canvasWidth: canvasWidth,
        canvasHeight: canvasHeight,
        points: resampledPoints
    };
    let blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
    let linkJson = document.createElement('a');
    linkJson.href = URL.createObjectURL(blob);
    linkJson.download = `trial_${Date.now()}_data.json`;
    linkJson.click();
}
</script>
</body>
</html>
